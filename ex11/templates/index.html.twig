{% extends 'base.html.twig' %}

{% block title %}Liste des personnes et données liées{% endblock %}

{% block body %}
    <h1>Liste (tri/jointure/filtre SQL pur)</h1>
    {% for msg in app.flashes('notice') %}
        <div class="alert">{{ msg|raw }}</div>
    {% endfor %}

    <div class="form-wrapper" style="flex-direction:row;justify-content:center;gap:2em;margin-bottom:2em;">
        <form action="{{ path('ex11_add_test_persons') }}" method="post" style="display:inline;">
            <button type="submit"
                {% if total_people is defined and total_people >= 10 %}disabled style="background:#ccc;color:#666;"{% endif %}>
                Ajouter des personnes de test
            </button>
            {% if total_people is defined and total_people >= 10 %}
                <span style="color:#aaa;margin-left:1em;">(maximum atteint)</span>
            {% endif %}
        </form>
        <form action="{{ path('ex11_drop_tables') }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer TOUTES les tables et leurs données ?');">
            <button type="submit" style="background:#e3342f;">Supprimer toutes les tables</button>
        </form>
    </div>

<form method="get" class="form-wrapper" style="max-width:450px;margin:0 auto 2em auto;">
    <label>Filtrer par nom :</label>
    <input type="text" name="filter_name" value="{{ filter_name }}">

    <label>Trier par :</label>
    <select name="sort_by">
        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nom</option>
        <option value="email" {% if sort_by == 'email' %}selected{% endif %}>Email</option>
        <option value="city" {% if sort_by == 'city' %}selected{% endif %}>Ville</option>
        <option value="birthdate" {% if sort_by == 'birthdate' %}selected{% endif %}>Date de naissance</option>
    </select>
    <select name="sort_dir">
        <option value="asc" {% if sort_dir == 'asc' %}selected{% endif %}>Croissant</option>
        <option value="desc" {% if sort_dir == 'desc' %}selected{% endif %}>Décroissant</option>
    </select>

    <div style="display:flex; gap:1em; justify-content:center;">
        <button type="submit" name="filter_submit" value="Rechercher">Rechercher</button>
        <button type="submit" name="sort_submit" value="Trier">Trier</button>
    </div>
</form>

    <table>
        <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Ville</th>
            <th>Rue</th>
            <th>IBAN</th>
            <th>Banque</th>
            <th>Date de naissance</th>
        </tr>
        {% for item in data %}
            <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.email }}</td>
                <td>{{ item.city }}</td>
                <td>{{ item.street }}</td>
                <td>{{ item.iban }}</td>
                <td>{{ item.bank_name }}</td>
                <td>{{ item.birthdate }}</td>
            </tr>
        {% else %}
            <tr><td colspan="7" style="text-align:center;color:#888;">Aucune donnée trouvée.</td></tr>
        {% endfor %}
    </table>
{% endblock %}

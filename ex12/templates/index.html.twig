{% extends 'base.html.twig' %}

{% block title %}Ex12 — ORM, jointures, filtre et tri{% endblock %}

{% block body %}
    <h1>Ex12 — ORM, jointures, filtre, tri</h1>
    {% for msg in app.flashes('notice') %}
        <div class="alert">{{ msg|raw }}</div>
    {% endfor %}

    <div class="form-wrapper" style="flex-direction:row;justify-content:center;gap:2em;margin-bottom:2em;">
        <form action="{{ path('ex12_add_test_persons') }}" method="post" style="display:inline;">
            <button type="submit"
                {% if total_people >= 10 %}disabled style="background:#ccc;color:#666;"{% endif %}>
                Ajouter des personnes de test
            </button>
            {% if total_people >= 10 %}
                <span style="color:#aaa;margin-left:1em;">(maximum atteint)</span>
            {% endif %}
        </form>
        <form action="{{ path('ex12_drop_all') }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer TOUTES les personnes et leurs données ?');">
            <button type="submit" style="background:#e3342f;">Supprimer toutes les personnes</button>
        </form>
    </div>

<form method="get" class="form-wrapper" style="max-width:450px;margin:0 auto 2em auto;">
    <label>Filtrer par nom :</label>
    <input type="text" name="filter_name" value="{{ filter_name }}">

    <label>Trier par :</label>
    <select name="sort_by">
        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nom</option>
        <option value="email" {% if sort_by == 'email' %}selected{% endif %}>Email</option>
        <option value="city" {% if sort_by == 'city' %}selected{% endif %}>Ville</option>
        <option value="birthdate" {% if sort_by == 'birthdate' %}selected{% endif %}>Date de naissance</option>
    </select>
    <select name="sort_dir">
        <option value="asc" {% if sort_dir == 'asc' %}selected{% endif %}>Croissant</option>
        <option value="desc" {% if sort_dir == 'desc' %}selected{% endif %}>Décroissant</option>
    </select>

    <div style="display:flex; gap:1em; justify-content:center;">
        <button type="submit" name="filter_submit" value="Rechercher">Rechercher</button>
        <button type="submit" name="sort_submit" value="Trier">Trier</button>
    </div>
</form>

    <table>
        <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Ville</th>
            <th>Rue</th>
            <th>IBAN</th>
            <th>Banque</th>
            <th>Date de naissance</th>
        </tr>
        {% for person in people %}
            <tr>
                <td>{{ person.name }}</td>
                <td>{{ person.email }}</td>
                <td>
                    {{ person.addresses|length > 0 ? person.addresses[0].city : '-' }}
                </td>
                <td>
                    {{ person.addresses|length > 0 ? person.addresses[0].street : '-' }}
                </td>
                <td>
                    {{ person.bankAccount ? person.bankAccount.iban : '-' }}
                </td>
                <td>
                    {{ person.bankAccount ? person.bankAccount.bankName : '-' }}
                </td>
                <td>
                    {{ person.birthdate ? person.birthdate|date('Y-m-d') : '-' }}
                </td>
            </tr>
        {% else %}
            <tr><td colspan="7" style="text-align:center;color:#888;">Aucune donnée trouvée.</td></tr>
        {% endfor %}
    </table>
{% endblock %}
